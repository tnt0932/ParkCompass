/*! parkcompass - v1.0.0 - 2014-10-12
* https://github.com/tnt0932/parkcompass
* Copyright (c) 2014 ; Licensed MIT */
function load(a,b){userMarkerPosition=new google.maps.LatLng(a,b),map=new google.maps.Map(document.getElementById("map_canvas"),{center:userMarkerPosition,zoom:12,mapTypeId:"roadmap",mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}}),infoWindow=new google.maps.InfoWindow,search_result_list=document.getElementById("search_results_list"),createUserMarker(map,userMarkerPosition),searchLocationsNear(userMarkerPosition)}function searchLocations(){var a=document.getElementById("location_search_input").value,b=new google.maps.Geocoder;b.geocode({address:a},function(b,c){c==google.maps.GeocoderStatus.OK?(userMarkerPosition=b[0].geometry.location,searchLocationsNear(),clearUserMarker(),createUserMarker(map,b[0].geometry.location),map.setCenter(b[0].geometry.location)):alert(a+" not found")})}function searchLocationsNear(){clearLocations();var a=100,b="pc_genxml.php?lat="+userMarkerPosition.lat()+"&lng="+userMarkerPosition.lng()+"&radius="+a+"&filters="+JSON.stringify(clickedFilters);downloadUrl(b,function(a){var b=parseXml(a);getParksData(b)}),$.getJSON(b,function(a){getParksData(a)})}function getParksData(a,b){console.log(b);var c=new google.maps.LatLngBounds,d=a.documentElement.getElementsByTagName("park");if(0===d.length)return userMarkerPosition=new google.maps.LatLng(49.25,-123.133333),alert("No Metro Vancouver parks found in that area. We're going to move your marker back to the heart of Vancouver!"),clearUserMarker(),createUserMarker(map,userMarkerPosition),searchLocationsNear(),void map.setCenter(userMarkerPosition);for(var e=0;e<d.length;e++){for(var f,g=[],h=d[e].childNodes,i=0;i<h.length;i++){var j=h[i].getAttribute("fType"),k=h[i].getAttribute("fQuan");f=[j,k],g.push(f)}var l=d[e].getAttribute("pName"),m=d[e].getAttribute("pAddress"),n=d[e].getAttribute("nName"),o=d[e].getAttribute("slug"),p=d[e].getAttribute("pID"),q=new google.maps.LatLng(parseFloat(d[e].getAttribute("pLat")),parseFloat(d[e].getAttribute("pLng"))),r=parseFloat(d[e].getAttribute("distance"));createResults(l,r,e),createMarker(q,l,m,n,g,o,p),c.extend(q)}var s={maxZoom:14,minimumClusterSize:4};markerCluster=new MarkerClusterer(map,markers,s),markerClusterExists=!0,search_result_list.style.visibility="visible",search_result_list.onclick=function(a){var b=a.target.parentNode.id;google.maps.event.trigger(markers[b],"click")}}function createResults(a,b,c){var d=document.createElement("li");d.id=c,d.className="search_result",d.innerHTML="<h2>"+a+"</h2><h2>"+b.toFixed(1)+"km</h2>",search_result_list.appendChild(d)}function showingResultsFor(){var a=new google.maps.Geocoder;a.geocode({latLng:userMarkerPosition},function(a,b){b==google.maps.GeocoderStatus.OK?a[1]&&(document.getElementById("showing_results_for_span").innerHTML=a[0].formatted_address):alert("Geocoder failed due to: "+b)})}function createMarker(a,b,c,d,e,f,g){for(var h="http://maps.google.com/maps?saddr="+userMarkerPosition+"&daddr="+a,i="http://parkcompass.com/"+f,j="<ul>",k=0;k<e.length;k++)j+="<li>"+e[k][0]+"<span>"+e[k][1]+"</span></li>";j+="</ul>";var l='<div class="infowindow"><div id="photo'+g+'"></div><h2>'+b+"</h2><br/><p>Address: <b>"+c+"</b></p><br/><p>Neighbourhood: <b>"+d+"</b></p><br>"+j+"<br><p>Share:<br><input type='text' value='"+i+"' onclick='this.select()' class='parkLink'><a href='"+h+"' target='_blank'>Directions</a>",m=new google.maps.Marker({map:map,position:a,icon:parkIcon,shadow:parkIconShadow});google.maps.event.addListener(m,"click",function(){infoWindow.setContent(l),infoWindow.open(map,m)}),markers.push(m)}function clearLocations(){infoWindow.close();for(var a=0;a<markers.length;a++)markers[a].setMap(null);markers.length=0,search_result_list.innerHTML="",markerClusterExists&&(markerCluster.clearMarkers(),markerClusterExists=!1)}function createUserMarker(a,b){showingResultsFor(b);var c=new google.maps.Marker({map:a,position:b,icon:userIcon,shadow:userIconShadow,draggable:!0,zIndex:99999});google.maps.event.addListener(c,"dragend",function(){userMarkerPosition=c.getPosition(),searchLocationsNear(),showingResultsFor()}),userMarker.push(c)}function clearUserMarker(){for(var a=0;a<userMarker.length;a++)userMarker[a].setMap(null);userMarker.length=0}function geolocation(){function a(a){alert(a===!0?"Geolocation service failed. We've placed you in Downtown Vancouver.":"Your browser doesn't support geolocation so we've placed you in the heart of Vancouver!"),map.setCenter(userMarkerPosition)}navigator.geolocation?(browserSupportFlag=!0,navigator.geolocation.getCurrentPosition(function(a){userMarkerPosition=new google.maps.LatLng(a.coords.latitude,a.coords.longitude),searchLocationsNear(),clearUserMarker(),createUserMarker(map,userMarkerPosition),map.setCenter(userMarkerPosition)},function(){a(browserSupportFlag)})):(browserSupportFlag=!1,a(browserSupportFlag))}function downloadUrl(a,b){var c=window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest;c.onreadystatechange=function(){4==c.readyState&&(c.onreadystatechange=doNothing,b(c.responseText,c.status))},c.open("GET",a,!0),c.send(null)}function parseXml(a){if(window.ActiveXObject){var b=new ActiveXObject("Microsoft.XMLDOM");return b.loadXML(a),b}return window.DOMParser?(new DOMParser).parseFromString(a,"text/xml"):void 0}function doNothing(){}var map,xml,markers=[],userMarker=[],infoWindow,search_result_list,userMarkerPosition=new google.maps.LatLng(49.25,-123.133333),parkIcon="img/park_icon.png",parkIconShadowURL="img/park_icon_shadow.png",parkIconShadowSize=new google.maps.Size(31,32),parkIconShadowOrigin=new google.maps.Point(0,0),parkIconShadowAnchor=new google.maps.Point(0,31),parkIconShadow=new google.maps.MarkerImage(parkIconShadowURL,parkIconShadowSize,parkIconShadowOrigin,parkIconShadowAnchor),userIcon="img/user_icon.png",userIconShadowURL="img/user_icon_shadow.png",userIconShadowSize=new google.maps.Size(30,34),userIconShadowOrigin=new google.maps.Point(0,0),userIconShadowAnchor=new google.maps.Point(3,34),userIconShadow=new google.maps.MarkerImage(userIconShadowURL,userIconShadowSize,userIconShadowOrigin,userIconShadowAnchor),markerClusterExists=!1,initialLocation,browserSupportFlag,clickedFilters=[];$(document).ready(function(){$("#facilities_flyout").click(function(a){if("facilities_flyout"!=$(a.target).attr("id")){var b=$(a.target).attr("id").substr(6);if($(a.target).hasClass("facility_selected")){$(a.target).removeClass("facility_selected");for(var c=0;c<clickedFilters.length;c++)clickedFilters[c]==b&&clickedFilters.splice(c,1)}else $(a.target).addClass("facility_selected"),clickedFilters.push(b);searchLocationsNear()}}),$("#remove_all_filters_btn").click(function(){clickedFilters.length=0,$("#facilities_flyout a").removeClass("facility_selected"),searchLocationsNear()})});